<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>Program Uygulaması</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f5f7fa;
      padding: 20px;
      color: #333;
    }
    header {
      background-color: #007acc;
      color: white;
      padding: 15px;
      text-align: center;
      font-size: 1.8rem;
      margin-bottom: 20px;
      letter-spacing: 2px;
      position: relative;
    }
    #backBtn {
      position: absolute;
      left: 15px;
      top: 15px;
      background: white;
      color: #007acc;
      border: none;
      padding: 6px 10px;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
    }
    #backBtn:hover {
      background: #e0eaff;
    }
    form {
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      max-width: 400px;
      margin-bottom: 20px;
    }
    form input, form select, form button {
      width: 100%;
      padding: 8px;
      margin-top: 10px;
      border-radius: 5px;
      border: 1px solid #ccc;
      font-size: 1rem;
      box-sizing: border-box;
    }
    #tasks {
      max-width: 600px;
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    .task {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 5px;
      border-bottom: 1px solid #ddd;
    }
    .task:last-child {
      border-bottom: none;
    }
    .task-info {
      flex-grow: 1;
    }
    .task-time {
      font-weight: bold;
      color: #007acc;
      margin-left: 15px;
      min-width: 70px;
      text-align: center;
    }
    button.start-btn {
      background: #007acc;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 5px;
      cursor: pointer;
    }
    button.start-btn:hover {
      background: #005fbb;
    }
  </style>
</head>
<body>
  <header>
    Program Uygulaması
    <button id="backBtn" onclick="goBack()">← Geri Dön</button>
  </header>

  <form id="taskForm">
    <label for="taskName">Görev Adı:</label>
    <input type="text" id="taskName" placeholder="Örneğin: Matematik çalış" required />

    <label for="taskDate">Tarih:</label>
    <input type="date" id="taskDate" required />

    <label for="taskTime">Saat:</label>
    <input type="time" id="taskTime" required />

    <label for="taskDuration">Süre (dakika):</label>
    <input type="number" id="taskDuration" min="1" max="180" value="25" required />

    <button type="submit">Görev Ekle</button>
  </form>

  <div id="tasks"></div>

  <script>
    const form = document.getElementById('taskForm');
    const tasksDiv = document.getElementById('tasks');
    let timer = null;
    let currentTaskId = null;

    // Görevleri localStorage'dan yükle
    function loadTasks() {
      const tasks = JSON.parse(localStorage.getItem('tasks') || '[]');
      renderTasks(tasks);
    }

    // Görevleri göster
    function renderTasks(tasks) {
      if(tasks.length === 0) {
        tasksDiv.innerHTML = '<p>Henüz görev yok.</p>';
        return;
      }

      tasksDiv.innerHTML = '';
      tasks.forEach(task => {
        const div = document.createElement('div');
        div.className = 'task';

        const info = document.createElement('div');
        info.className = 'task-info';
        info.textContent = `${task.name} - ${task.date} ${task.time}`;

        const timeLeft = document.createElement('div');
        timeLeft.className = 'task-time';
        timeLeft.id = `time-${task.id}`;
        timeLeft.textContent = task.remainingTime !== undefined ? formatTime(task.remainingTime) : formatTime(task.duration * 60);

        const startBtn = document.createElement('button');
        startBtn.textContent = currentTaskId === task.id ? 'Durdur' : 'Başlat';
        startBtn.className = 'start-btn';
        startBtn.onclick = () => toggleTimer(task.id);

        div.appendChild(info);
        div.appendChild(timeLeft);
        div.appendChild(startBtn);

        tasksDiv.appendChild(div);
      });
    }

    // Zaman formatı (mm:ss)
    function formatTime(seconds) {
      const m = Math.floor(seconds / 60).toString().padStart(2, '0');
      const s = (seconds % 60).toString().padStart(2, '0');
      return `${m}:${s}`;
    }

    // Timer başlat/durdur
    function toggleTimer(id) {
      const tasks = JSON.parse(localStorage.getItem('tasks') || '[]');

      // Aynı görevde timer çalışıyorsa durdur
      if(currentTaskId === id) {
        clearInterval(timer);
        timer = null;
        currentTaskId = null;
        updateStartButtons();
        return;
      }

      // Başka görevde timer varsa durdur
      if(timer) {
        clearInterval(timer);
        timer = null;
        currentTaskId = null;
      }

      currentTaskId = id;
      const task = tasks.find(t => t.id === id);

      // Eğer remainingTime yoksa duration'a göre başlat
      if(task.remainingTime === undefined) {
        task.remainingTime = task.duration * 60;
      }

      updateTask(task);
      updateStartButtons();

      timer = setInterval(() => {
        if(task.remainingTime > 0) {
          task.remainingTime--;
          updateTask(task);
          renderTasks(tasks);
        } else {
          clearInterval(timer);
          timer = null;
          currentTaskId = null;
          alert(`⏰ "${task.name}" görevi tamamlandı!`);
          // Ses çalma
          playAlarm();
          task.remainingTime = undefined;
          updateTask(task);
          renderTasks(tasks);
          updateStartButtons();
        }
      }, 1000);
    }

    // Görev güncelle
    function updateTask(task) {
      const tasks = JSON.parse(localStorage.getItem('tasks') || '[]');
      const idx = tasks.findIndex(t => t.id === task.id);
      if(idx !== -1) {
        tasks[idx] = task;
        localStorage.setItem('tasks', JSON.stringify(tasks));
      }
    }

    // Başlat/durdur butonlarını güncelle
    function updateStartButtons() {
      const buttons = document.querySelectorAll('.start-btn');
      buttons.forEach(btn => {
        const parent = btn.parentElement;
        const timeDiv = parent.querySelector('.task-time');
        const taskText = parent.querySelector('.task-info').textContent;
        const id = getIdFromTimeDiv(timeDiv.id);
        btn.textContent = (currentTaskId === id) ? 'Durdur' : 'Başlat';
      });
    }

    function getIdFromTimeDiv(idStr) {
      return parseInt(idStr.split('-')[1]);
    }

    // Görev ekle
    form.addEventListener('submit', (e) => {
      e.preventDefault();
      const name = document.getElementById('taskName').value.trim();
      const date = document.getElementById('taskDate').value;
      const time = document.getElementById('taskTime').value;
      const duration = parseInt(document.getElementById('taskDuration').value);

      if(!name || !date || !time || !duration || duration < 1) {
        alert('Lütfen tüm alanları doğru doldurun.');
        return;
      }

      const tasks = JSON.parse(localStorage.getItem('tasks') || '[]');
      const newTask = {
        id: Date.now(),
        name,
        date,
        time,
        duration,
      };
      tasks.push(newTask);
      localStorage.setItem('tasks', JSON.stringify(tasks));
      renderTasks(tasks);
      form.reset();
    });

    // Geri dön butonu
    function goBack() {
      window.location.href = "index.html";
    }

    // Alarm sesi
    function playAlarm() {
      const audio = new Audio('https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg');
      audio.play();
    }

    // Sayfa yüklendiğinde görevleri göster
    loadTasks();
  </script>
</body>
</html>
